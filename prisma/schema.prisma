// Prisma Schema for YouTube Playlist Sync Module
// Database: SQLite (development), PostgreSQL (production)

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================================================
// Core Models
// ============================================================================

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  name         String
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Playlist {
  id           String         @id @default(uuid())
  youtubeId    String         @unique @map("youtube_id")
  title        String
  description  String?
  channelId    String         @map("channel_id")
  channelTitle String         @map("channel_title")
  thumbnailUrl String?        @map("thumbnail_url")
  itemCount    Int            @default(0) @map("item_count")
  syncStatus   String         @default("PENDING") @map("sync_status")
  lastSyncedAt DateTime?      @map("last_synced_at")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")

  items        PlaylistItem[]
  syncHistory  SyncHistory[]

  @@map("playlists")
}

model Video {
  id            String          @id @default(uuid())
  youtubeId     String          @unique @map("youtube_id")
  title         String
  description   String?
  channelId     String          @map("channel_id")
  channelTitle  String          @map("channel_title")
  publishedAt   DateTime        @map("published_at")
  duration      Int             // in seconds
  thumbnailUrls String          @map("thumbnail_urls") // JSON string
  viewCount     Int             @default(0) @map("view_count")
  likeCount     Int             @default(0) @map("like_count")
  commentCount  Int             @default(0) @map("comment_count")
  tags          String?         // JSON string array
  categoryId    String?         @map("category_id")
  language      String?
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  playlistItems PlaylistItem[]
  userState     UserVideoState?
  captions      VideoCaption[]
  notes         VideoNote[]
  watchSessions WatchSession[]

  @@map("videos")
}

model PlaylistItem {
  id         String    @id @default(uuid())
  playlistId String    @map("playlist_id")
  videoId    String    @map("video_id")
  position   Int
  addedAt    DateTime  @map("added_at")
  removedAt  DateTime? @map("removed_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  playlist   Playlist  @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  video      Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([playlistId, videoId, addedAt])
  @@index([playlistId, position])
  @@index([videoId])
  @@index([playlistId, addedAt])
  @@map("playlist_items")
}

model UserVideoState {
  id           String      @id @default(uuid())
  videoId      String      @unique @map("video_id")
  watchStatus  String      @default("UNWATCHED") @map("watch_status")
  lastPosition Int         @default(0) @map("last_position") // in seconds
  watchCount   Int         @default(0) @map("watch_count")
  notes        String?
  summary      String?
  tags         String?     // JSON string array
  rating       Int?        // 1-5
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  video        Video       @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@map("user_video_states")
}

// ============================================================================
// Operational Models
// ============================================================================

model SyncHistory {
  id          String     @id @default(uuid())
  playlistId  String     @map("playlist_id")
  status      String
  startedAt   DateTime   @map("started_at")
  completedAt DateTime?  @map("completed_at")
  duration    Int?       // in milliseconds
  itemsAdded  Int        @default(0) @map("items_added")
  itemsRemoved Int       @default(0) @map("items_removed")
  itemsReordered Int     @default(0) @map("items_reordered")
  quotaUsed   Int        @default(0) @map("quota_used")
  errorMessage String?   @map("error_message")
  createdAt   DateTime   @default(now()) @map("created_at")

  playlist    Playlist   @relation(fields: [playlistId], references: [id], onDelete: Cascade)

  @@index([playlistId, startedAt])
  @@index([status])
  @@map("sync_history")
}

model QuotaUsage {
  id        String   @id @default(uuid())
  date      DateTime @unique
  used      Int      @default(0)
  limit     Int      @default(10000)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  operations QuotaOperation[]

  @@map("quota_usage")
}

model QuotaOperation {
  id           String      @id @default(uuid())
  quotaUsageId String      @map("quota_usage_id")
  operationType String     @map("operation_type")
  cost         Int
  timestamp    DateTime    @default(now())

  quotaUsage   QuotaUsage  @relation(fields: [quotaUsageId], references: [id], onDelete: Cascade)

  @@index([quotaUsageId])
  @@index([timestamp])
  @@map("quota_operations")
}

model Credentials {
  id        String   @id @default(uuid())
  userId    String   @unique @default("default") @map("user_id")
  data      String   // Encrypted JSON
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("credentials")
}

model SyncSchedule {
  id          String    @id @default(uuid())
  playlistId  String    @unique @map("playlist_id")
  interval    Int       // in milliseconds
  enabled     Boolean   @default(true)
  lastRun     DateTime? @map("last_run")
  nextRun     DateTime  @map("next_run")
  retryCount  Int       @default(0) @map("retry_count")
  maxRetries  Int       @default(3) @map("max_retries")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@index([nextRun, enabled])
  @@map("sync_schedules")
}

// ============================================================================
// Phase 2: Learning Platform Models
// ============================================================================

model VideoCaption {
  id        String   @id @default(uuid())
  videoId   String   @map("video_id")
  language  String
  text      String   // Full transcript
  segments  String   // JSON array of {text, start, duration}
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, language])
  @@index([videoId])
  @@map("video_captions")
}

model VideoNote {
  id        String   @id @default(uuid())
  videoId   String   @map("video_id")
  timestamp Int      // in seconds
  content   String   // Markdown text
  tags      String?  // JSON array
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId, timestamp])
  @@map("video_notes")
}

model WatchSession {
  id        String   @id @default(uuid())
  videoId   String   @map("video_id")
  startedAt DateTime @map("started_at")
  endedAt   DateTime @map("ended_at")
  startPos  Int      @map("start_pos") // in seconds
  endPos    Int      @map("end_pos")   // in seconds
  duration  Int      // actual watch duration in seconds
  createdAt DateTime @default(now()) @map("created_at")

  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId, startedAt])
  @@map("watch_sessions")
}

// ============================================================================
// Universal Adapter Models (DataSourceAdapter)
// ============================================================================

model Collection {
  id              String    @id @default(uuid())
  sourceId        String    @map("source_id")    // YouTube playlist ID, Notion database ID, etc.
  sourceType      String    @map("source_type")  // 'youtube', 'notion', 'linkedin', etc.
  sourceUrl       String?   @map("source_url")   // Original URL

  title           String
  description     String?
  creatorId       String?   @map("creator_id")   // Channel ID, user ID, author ID
  creatorName     String?   @map("creator_name") // Channel title, username, author name
  thumbnailUrl    String?   @map("thumbnail_url")

  itemCount       Int       @default(0) @map("item_count")

  publishedAt     DateTime? @map("published_at")
  lastModifiedAt  DateTime? @map("last_modified_at")

  metadata        String?   // JSON: source-specific metadata

  syncStatus      String    @default("PENDING") @map("sync_status")
  lastSyncedAt    DateTime? @map("last_synced_at")

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  items           CollectionItemLink[]

  @@unique([sourceId, sourceType])
  @@index([sourceType])
  @@index([syncStatus])
  @@index([lastSyncedAt])
  @@map("collections")
}

model CollectionItemLink {
  id            String    @id @default(uuid())
  collectionId  String    @map("collection_id")
  contentItemId String    @map("content_item_id")

  sourceId      String    @map("source_id")      // Video ID, page ID, file path within source
  sourceType    String    @map("source_type")
  position      Int

  addedAt       DateTime  @map("added_at")
  removedAt     DateTime? @map("removed_at")

  metadata      String?   // JSON: source-specific metadata

  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  collection    Collection  @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  contentItem   ContentItem @relation(fields: [contentItemId], references: [id], onDelete: Cascade)

  @@unique([collectionId, contentItemId])
  @@index([collectionId, position])
  @@index([contentItemId])
  @@map("collection_item_links")
}

model ContentItem {
  id              String    @id @default(uuid())
  sourceId        String    @map("source_id")    // YouTube video ID, Notion page ID, file path
  sourceType      String    @map("source_type")  // 'youtube', 'notion', 'linkedin', etc.
  sourceUrl       String?   @map("source_url")   // Original URL

  title           String
  description     String?
  content         String?   // Full text content (Markdown)
  contentType     String    @map("content_type") // 'video', 'article', 'document', 'note', etc.

  creatorId       String?   @map("creator_id")
  creatorName     String?   @map("creator_name")

  thumbnailUrls   String?   @map("thumbnail_urls") // JSON: {default, medium, high, standard, maxres}

  duration        Int?      // seconds (for video/audio)
  publishedAt     DateTime? @map("published_at")
  lastModifiedAt  DateTime? @map("last_modified_at")

  tags            String?   // JSON array
  category        String?
  language        String?

  metadata        String?   // JSON: source-specific metadata (viewCount, likeCount, etc.)

  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  collections     CollectionItemLink[]

  @@unique([sourceId, sourceType])
  @@index([sourceType])
  @@index([contentType])
  @@index([publishedAt])
  @@map("content_items")
}

// ============================================================================
// Note: Enums are replaced with String fields for SQLite compatibility
// Valid values are enforced at the application layer:
//
// SyncStatus: "PENDING" | "IN_PROGRESS" | "COMPLETED" | "FAILED"
// WatchStatus: "UNWATCHED" | "WATCHING" | "COMPLETED"
// SourceType: "youtube" | "notion" | "linkedin" | "file" | "google_drive" | "vimeo" | "spotify" | string
// ContentType: "video" | "article" | "document" | "note" | "audio" | "image" | "playlist" | string
// ============================================================================
